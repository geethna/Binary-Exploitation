#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#define MAX 10

char lowScores[MAX][4];

void getinp(char* ptr, unsigned long size){
    int r = read(STDIN_FILENO, ptr, size);
    if (r == -1){
        perror("read error!");
        exit(-1);
    }
}

int getint(){
    char ptr[0x30]={0};
    getinp(ptr, 0x20);
    return atoi(ptr);
}

int getPositive(int a){
    if (a < 0)
        return -1*a;
    else
        return a;
}

int safeAdd(int a, int b){
    asm(
      "mov edi, dword ptr [ebp+0x8];"
      "mov esi, dword ptr [ebp+0xc];"
      "add edi, esi;"
      "jo exit;"              // Our hackers are smart, they know 2 positives make a negative

      "xor eax, eax;"
      "mov eax, edi;"
      "leave;"
      "ret;"

      "exit:"
      "mov ebx, 0xff;"
      "mov eax, 1;"
      "int 0x80;"
    );
}

int add(){
    int a,b;

    printf("Enter first number: ");
    a = getint();
    printf("Enter second number: ");
    b = getint();

    /* We only accept positive numbers. If number is negative, make it positive.. */
    a = getPositive(a);
    b = getPositive(b);

    return safeAdd(a, b);

}

void initialise()
{
  setvbuf(stdin, NULL, _IONBF, 0);
  setvbuf(stdout, NULL, _IONBF, 0);
}

int main(){

    int check = 0, result = 0;

    initialise();

    system("echo 'Here you go! You have system plt. Dont complain about libc :)'");

    while(1){

        result = add();

        if (result < MAX){
            puts("Congrats! Your result is so low that you make it lowScores!!!");
            printf("Give your nickname: ");
            getinp(lowScores[result], 4);
        }
        else{
            puts("Sigh! You scored too high! Highest DOES NOT win here!");
        }

        printf("Play Again (0/1) ? ");
        check = getint();

        if (check == 0){
            puts("Okay, bye!");
            break;
        }
    }

	return 0;
}
