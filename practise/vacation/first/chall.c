#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#define MAX 12

typedef struct note
{
  char title[32];
  char* desc;
  unsigned int dsize;
}note;

note* table[MAX]={0};
unsigned long size[MAX];

int getinp(char* ptr, int size)
{
  int ret = read(0,ptr,size-1);
  if (ret<0)
    exit(0);
  ptr[ret-1]='\0';
  return ret-1;
}

int getint()
{
  char buf[30];
  getinp(buf,30);
  return atoi(buf);
}

void add()
{
  int i=0;
  for (i=0;i<=MAX;i++)
    if (table[i]==NULL)
      break;
  if (i==MAX)
  {
    puts("Outta space dude!");
    exit(0);
  }
  printf("Enter size: ");
  int title_size = getint();
  if (title_size<=0 || title_size>=30)
  {
    puts("Lol, can't give such a simple bof!");
    exit(0);
  }
  note* entry = (note*)malloc(sizeof(note));
  printf("Enter title: ");
  getinp(entry->title, title_size);
  printf("Enter desc size: ");
  unsigned int desc_size = getint();
  if (desc_size > 1000)
  {
    puts("Whoa, your RAM might be huge, mine ain't!");
    exit(0);
  }
  entry->desc = (char*)malloc(desc_size);
  printf("Enter desc: ");
  getinp(entry->desc, desc_size);
  entry->dsize=desc_size;
  table[i]=entry;
  size[i]=title_size;
  return;
}

void show()
{
  puts("Whoops! Well lets just say you need to look somewhere else for a leak!");
  return;
  // printf("Enter index: ");
  // int idx = getint();
  // if (idx<0 || idx>=MAX)
  //   exit(0);
  // note* entry = table[idx];
  // printf("Name: %s\nDesc: %s\n",entry->title, entry->desc);
}

void delete()
{
  printf("Enter index: ");
  int idx = getint();
  if (idx<0 || idx>=MAX)
    exit(0);
  note* entry = table[idx];
  free(entry->desc);
  free(entry);
  table[idx]=NULL;
  size[idx]=0;
}

void edit()
{
  printf("Enter index: ");
  int idx = getint();
  if (idx<0 || idx>=MAX)
    exit(0);
  note* entry = table[idx];
  printf("Enter title: ");
  getinp(entry->title,size[idx]);
  printf("Enter desc: ");
  getinp(entry->desc,entry->dsize);
}

int menu()
{
  puts("1. Add note");
  puts("2. Edit note");
  puts("3. Show note");
  puts("4. Delete note");
  printf("Your Choice > ");
  return getint();
}

void initialise()
{
  setvbuf(stdin, NULL, _IONBF, 0);
  setvbuf(stdout, NULL, _IONBF, 0);
}

int main(int argc, char const *argv[]) {
  initialise();
  while(1)
  {
    int opt=menu();
    switch (opt)
    {
      case 1: add(); break;
      case 2: edit(); break;
      case 3: show(); break;
      case 4: delete(); break;
      default: puts("Invalid!");
    }
  }
  return 0;
}
