// gcc -no-pie chall.c -o challlenge3

#include<stdio.h>
#include<string.h>
#include<stdlib.h>
#include<unistd.h>

const int h1=1233322;
const int h2=9979776;
unsigned long hasher(char *str, unsigned long key) {
	int c;

	c=*str;
	while(*str++) {
		key += (key<<6) + c;
		c=*str;
	}
	return key;
}

struct secret {
	unsigned long  acc;
	unsigned long hash;
};

struct user {
	char name[0x18];
	int addr_size;
	char *address;
	unsigned long balance;
};

struct secret *table[10];
struct user *data[10];

void get_inp(char *str, int len) {
	do {
		read(0,str,1);
		len--;
	} while(len!=0 && *(str++)!='\n');
	if(*(--str)=='\n')
		*str='\0';
}

void initialize() {
	setvbuf(stdin,NULL,2,0);
	setvbuf(stdout,NULL,2,0);
}

void register_user() {
	int i=0;
	int len=0;
	int idx=0;
	char password[0x18];
	for(;i<10;i++) {
		if(!table[i])
			break;
	}
	if(i>=10) {
		puts("FULL");
		exit(0);
	}
	idx = i;
	puts("----Registeration Desk----");
	struct user *a =(struct user *)malloc(sizeof(struct user));
	printf("Enter your new username :");
	get_inp(a->name,20);
	for(i=0;i<10;i++) {
		if(data[i]){
			struct user *temp=data[i];
			if(!strncmp(a->name,temp->name,20)) {
				puts("Username taken");
				exit(0);
			}
		}
	}

	printf("Enter your new password :");
	get_inp(password,0x18);
	if(strlen(password)<8) {
		puts("Minimum 8 characters");
		exit(0);
	}

	printf("Enter the size of address :");
	scanf("%d",&len);
	if(len<=0 || len >=0x400){
		puts("Invalid Size");
		exit(0);
	}
	a->addr_size=len;
	a->address = (char*)malloc(len+1);
	printf("Enter your address :");
	get_inp(a->address,len);

	int ch=0;
	puts("Would you like to deposit money now ?");
	printf("1. Yes\n2. No\nEnter choice :");
	scanf("%d",&ch);
	int amount=0;
	if(ch==1) {
		printf("Enter the amount :");
		scanf("%d",&amount);
	}
	a->balance = amount;

	data[idx]=a;
	struct secret *b=(struct secret*)malloc(sizeof(struct secret));
	b->hash=hasher(password,h2);
	b->acc=hasher(a->name,h1);
	table[idx]=b;
	puts("Registeration Successful");
}

void print_menu() {
	puts("What servie would you like");
	puts("\t1. Deposit money");
	puts("\t2. Withdraw money");
	puts("\t3. Change username");
	puts("\t4. Reset password");
	puts("\t5. Update address");
	puts("\t6. Logout");
	printf("Enter your choice :");
}

void edit_addr(char *str, unsigned int size){
	printf("Enter the new address :");
	get_inp(str,size);
}

void login() {
	char username[0x18];
	printf("Enter your username :");
	get_inp(username,20);
	int idx=-1,i=0;
	for(;i<10;i++) {
		if(table[i]) {
			struct secret * temp = table[i];
			if(hasher(username,h1)==temp->acc) {
				puts("Username found");
				idx=i;
				break;
			}
		}
	}
	if(i==10) {
		puts("User does not exist");
		exit(0);
	}

	char password[0x18];
	printf("Enter your password :");
	get_inp(password,0x18);
	struct secret *temp = table[idx];
	if(hasher(password,h2)==temp->hash)
		puts("Login Successful");
	else {
		puts("Incorrect username of password");
		exit(0);
	}
	struct user *customer = data[idx];
	struct user *tmp;
	unsigned long amount=0;
	int size=0;
	while(1) {
		print_menu();
		int ch=0;
		scanf("%d",&ch);
		switch(ch) {
			case 1:
				printf("Enter deposit amount :");
				scanf("%lu",&amount);
				customer->balance += amount;
				printf("Your current balance = %lu\n",customer->balance);
				break;

			case 2:
				printf("Enter withdraw amount :");
				scanf("%lu",&amount);
				customer->balance -= amount;
				printf("Your current balance = %lu\n",customer->balance);
				break;

			case 3: printf("Enter your new username :");
				memset(username,'\xff',0x18);
				get_inp(username,20);
				for(i=0;i<10;i++) {
					if(data[i]){
						tmp=data[i];
						if(!strncmp(username,tmp->name,20)) {
							puts("Username taken");
							exit(0);
						}
					}
				}
				memset(customer->name,'\x00',0x18);
				strncpy(customer->name,username,0x18);
				temp->acc=hasher(customer->name,h1);
				puts("Username successfully updated");
				break;

			case 4: printf("Enter your new password :");
				get_inp(password,0x18);
				if(strlen(password)<8) {
					puts("Minimum 8 characters");
					exit(0);
				}
				temp->hash=hasher(password,h2);
				puts("Password successfully reset");
				break;

			case 5: printf("Enter the size of new addresss :");
				scanf("%d",&size);
				if(size>customer->addr_size){
					puts("Invalid Size; size too large");
					return;
				}
				edit_addr(customer->address,size);
				puts("Address successfully updated");
				break;

			default: puts("Logging out");
				return;
		}
	}
}

int main() {
	initialize();
	int ch;
	while(1) {
		puts("\tManage your money");
		puts("\t1. REGISTER");
		puts("\t2. LOGIN");
		puts("\t3. EXIT");
		printf("Enter your choice :");
		scanf("%d",&ch);
		switch(ch) {
			case 1: register_user();
				break;
			case 2: login();
				break;
			default: exit(0);
		}
	}
}
